<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Blog</title>
  <style>
    body {
      font-family: sans-serif;
      background: #111;
      color: #eee;
      margin: 2rem;
    }
    h1 {
      color: #f6c944;
    }
    .post {
      margin-bottom: 1rem;
      padding: 0.5rem;
      border-left: 3px solid #444;
    }
    .post a {
      color: #80d4ff;
      text-decoration: none;
      font-weight: bold;
      cursor: pointer;
    }
    .post small {
      display: block;
      color: #aaa;
    }
    #content {
      max-width: 800px;
      line-height: 1.6;
    }
    #back {
      display: inline-block;
      margin-top: 1rem;
      font-size: 0.9rem;
      color: #ccc;
      cursor: pointer;
    }
    pre, code {
      background: #222;
      padding: 0.2rem 0.4rem;
      border-radius: 4px;
      color: #fffdc2;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>

<h1 id="blog-title">ðŸ“˜ Blog</h1>
<div id="blog-list">Loading blog posts...</div>
<div id="content" style="display: none;"></div>
<div id="back" style="display: none;" onclick="goHome()">Back</div>

<script>
async function fetchMetadata(filename) {
  const res = await fetch(`blog/${filename}`);
  const text = await res.text();
  const matchString = /^---([\s\S]*?)---/
  const metaMatch = text.match(matchString);
  if (!metaMatch) return null;

  const metaLines = metaMatch[1].trim().split('\n');
  const meta = {};
  metaLines.forEach(line => {
    const [key, ...rest] = line.split(':');
    meta[key.trim()] = rest.join(':').trim();
  });

  meta.slug = filename.replace(/\.md$/, '');
  meta.filename = filename;
  meta.body = text.replace(matchString, '').trim();
  return meta;
}

async function loadBlogIndex() {
  const listEl = document.getElementById('blog-list');

  try {
    const res = await fetch('blog/files.json');
    const posts = await res.json();

    // Clean up
    posts.forEach(post => {
      for (let key in post) {
        if (typeof post[key] === 'string') {
          post[key] = post[key].replace(/\r/g, '');
        }
      }
    }

    // Sort newest first
    posts.sort((a, b) => new Date(b.date) - new Date(a.date));

    listEl.innerHTML = posts.map(post => `
      <div class="post">
        <a onclick="showPost('${post.slug}')">${post.title}</a>
        <small>${post.date}</small>
        <p>${post.description}</p>
      </div>
    `).join('');
  } catch (err) {
    listEl.innerHTML = `p style="color: red;">Failed to load blog index.</p>`;
    console.error("Failed to fetch blog index: ", err);
  }
}

async function showPost(slug) {
  try{
    const res = await fetch(`blog/${file}`);
    const posts = await res.json();
    const post = posts.find(p => p.slug === slug);

    if(!post) {
      document.getElementById('content').innerHTML = '<p>Post Not Found</p>';
      return;
    }

    const fileRes = await fetch(`blog\${post.filename}`);
    const text = await fileRes.text();
    const content = text.replace(/^---[\s\S]*?---/, '').trim();
    const html = marked.parse(content);

    document.title = post.title + ' | My Blog'
    document.getElementById('blog-list').style.display = 'none';
    document.getElementById('blog-title').innerText = '';
    document.getElementById('content').style.display = 'block';
    document.getElementById('back').style.display = 'inline-block';
    document.getElementById('content').innerHTML = html;

    history.pushState({}, '', `?post=${slug}`);
  } catch (err) {
    document.getElementById('content').innerHTML = '<p>Error loading post.</p>';
    console.error("Failed to load blog post:", err);
  }
}

function goHome() {
  document.title = 'My Blog';
  history.pushState({}, '', window.location.pathname);
  document.getElementById('blog-list').style.display = 'block';
  document.getElementById('blog-title').innerText = 'ðŸ“˜ Reflex Blog';
  document.getElementById('content').style.display = 'none';
  document.getElementById('back').style.display = 'none';
}

// Deep link support
function checkUrl() {
  const params = new URLSearchParams(window.location.search);
  const slug = params.get('post');
  if (slug) {
    showPost(slug);
  } else {
    loadBlogIndex();
  }
}

checkUrl();
</script>

</body>
</html>
